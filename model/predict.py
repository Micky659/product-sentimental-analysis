import pickle
import numpy as np
import os
import torch

from .LSTM import LSTMClassifier
from .utils import review_to_words, convert_and_pad


def prediction(reviews):

    initalize_LSTM()
    review_sentiments = []
    review_score = []
    major_words = []

    for review in reviews:
        words = review_to_words(review)
        data_X, data_len = convert_and_pad(model.word_dict, words)

        data_pack = np.hstack((data_len, data_X))
        data_pack = data_pack.reshape(1, -1)

        data = torch.from_numpy(data_pack)
        data = data.to(device)

        model.eval()

        with torch.no_grad():
            output = model.forward(data.long())

        result = np.round(output.numpy())

        if (result == 0):
            sentiment = 'Negative'
        elif (result == 1):
            sentiment = 'Positive'

        review_score.append(output.numpy()*10)
        review_sentiments.append(sentiment)
        major_words.extend(words)

    return review_sentiments, review_score, major_words


def initalize_LSTM():
    global model, device

    model_info_PATH = 'model/saved_models/model_info.pth'
    model_info = torch.load(model_info_PATH, map_location=torch.device('cpu'))

    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    model = LSTMClassifier(model_info['embedding_dim'], model_info['hidden_dim'], model_info['vocab_size'])

    model_PATH = 'model/saved_models/model.pth'
    model.load_state_dict(torch.load(model_PATH, map_location=torch.device('cpu')))

    word_dict_path = os.path.join('model/saved_models/word_dict.pkl')
    with open(word_dict_path, 'rb') as f:
        model.word_dict = pickle.load(f)

    model.to(device).eval()

# r, s, w = prediction(['I like this phone, so I\'ll start with the positive. Build quality is solid, the screen is bright and color accurate (though it has an ugly blemish - a hole punch camera in the top left corner), and it matches or beats out most other flagships on the market when it comes to specs (5G, Snapdragon 865, 12GB RAM, 256GB UFS 3.1 storage, 65W fast charging, stereo speakers, 4500mah battery). Camera quality is good, not better than that found on Google\'s Pixel series of phones but it\'s competitive with other brands like Samsung, Apple, Huawei, Xiaomi, etc. I\'m using the phone on Mint Mobile which uses T-Mobile\'s networks, I have had no issues with coverage and receive strong 5G signal in my area as well. The phone is not too big too handle nor too small to media consumption on. There\'s no wireless charging but I don\'t care about that in the slightest, especially when the phone charges so fast.The fingerprint reader is amazing. OnePlus seriously has the best in-screen fingerprint readers in the industry. It\'s accurate, fast, and so easy to use. I do not know of a phone with a better fingerprint reader. The phone is capable of facial recognition but I do not trust facial recognition as no matter how good the technology; it can be used to quickly unlock your phone without consent. To each their own.Another fantastic thing about this phone is that OnePlus still allows customers to unlock the bootloader of the device. Many other US smartphone manufacturers no longer allow you to do this. Why does this matter? When the phone reaches end-of-life and no longer receives support from the manufacturer you can flash an alternate ROM like LineageOS. It also allows you to root your device if you\'re into that sort of thing. I personally think it should be criminal to sell a device with a locked bootloader. Can you imagine if you bought a laptop running Windows 8 but were artificially prohibited from upgrading to Windows 10? Many smartphone brands do the equivalent of this and I refuse to purchase their products because of it. Thank you OnePlus for respecting consumer choice and fighting e-waste.The phone\'s software is smooth and fairly close to a "stock" Android experience. Some tweaks are definitely made under the hood but OxygenOS is far from obtrusive and is highly customizable. Of course, having an unlockable bootloader means you have the freedom to load something else if you want. One thing I love is that unlike some other brands, OnePlus mostly relies on Google\'s own software suite of apps and doesn\'t attempt to force duplicate manufacturer-branded versions of things like e-mail software on the user. There are exceptions to this, special features such as "Zen mode" and OnePlus does have their own Gallery as well as a File Manager. I see the File Manager as a bit of an odd addition alongside the default Files app. My mentality is that device manufacturers shouldn\'t spend too much time on developing device-specific software. If a user has a problem with the default Files app they can find an alternative in the Play Store. I don\'t see it as necessary for OnePlus to include out of the box solutions to problems that may or may not exist for users. It\'s certainly not a bad app but it seems redundant. Keep it simple. Let people install what they want after they have the device in their hands. This is a minor grievance however. OxygenOS as a whole is smooth, responsive, and receives frequent updates. It\'s one of the few manufacturer Android skins I don\'t hate.This is where my review will turn a bit more critical. First things first, the hole punch camera. It\'s hideous. I have long been putting off buying a new phone because I hate how almost every flagship on the market has a notch or hole punch in its screen. Why? I never had a problem with bezels on my smartphone, and while having a high screen-to-body ratio is nice, it\'s not nice when it comes at the cost of putting a giant black dot in the corner of my screen. I watch a lot of videos and consume a lot of content on my device. Every time I look at this phone I see this ugly blemish on my screen, like a blob of dead pixels. I hate it. The only thing I can praise OnePlus for is that at least they put it in the left corner and not the center like some other manufacturers. It\'s still awful. You see it when the screen is off, when it\'s on, and it\'s especially noticeable when watching videos shot in aspect ratios wide enough to fill the screen (contrary to popular belief, many movies and online videos are not in 16:9). I know that OnePlus is not the only manufacturer to utilize a hole punch yet just because everyone else is doing it doesn\'t make it okay.Next, it lacks a 3.5mm audio jack, colloquially referred to as a "headphone jack". Again, OnePlus is not the only manufacturer to do this with their devices, that doesn\'t make it okay. I love listening to music. Thing is, Bluetooth quality sucks. I have a decent sound system in my car and I can clearly make out the difference between a wired connection and a Bluetooth one. I\'m switching from a Google Pixel XL which had a 3.5mm audio jack and I almost feel like I\'m downgrading. No 3.5mm to USB-C adapter is included in the box and OnePlus doesn\'t actually sell an official one listed as compatible with the OnePlus 8T. OnePlus is basically telling all their customers with hi-fi audio equipment that they don\'t care if said customers can enjoy their music. "Never Settle" seems like a silly slogan for OnePlus to have nowadays. There\'s plenty of space inside the phone and there is no official IP certification so I refuse to accept those as reasons to lack the jack.Next, there\'s the bloatware. There isn\'t a lot, though Netflix sticks out like a sore thumb. I use Netflix, there\'s nothing wrong with the app. The problem is that it comes preinstalled and can\'t be uninstalled. You can disable it if you like but it will still take up storage on your device. I don\'t think this is acceptable. If somebody has the desire to uninstall a preinstalled application they should be able to do so unless doing so would directly inhibit the functionality of the device. This is simply a consumer rights issue for me and I\'m pretty passionate about it.On a final note, the aesthetic of the phone is good. It looks like a flagship smartphone should and is built well. The hole punch camera makes the screen ugly, other than that I like how it looks. The Lunar Silver color is a bit less glossy than I was hoping for, and it almost looks blue under light. Personally I think the glossier silver finish of the OnePlus 7 Pro looked better. The screen is bright and color accurate though not as bright as I\'ve seen on a few other flagshipsOverall, I like this phone but dislike the compromises (hole punch camera, lack of 3.5mm audio jack, bloatware) that come with buying it. There\'s a lot to like, not enough to love. I was in desperate need of a phone and this was the only thing on the market that appealed to me at all. I really hate that I had to settle for a hole punch camera and no 3.5mm audio jack.Update: Decided to return this phone after it was causing me a lot of stress. I\'m not okay with where Bluetooth technology is in 2020 and I\'m disgusted by manufacturers removing the 3.5mm audio jack from devices and trying to force customers to use an inferior technology. Bluetooth sound quality is awful and it constantly fails to pair. I couldn\'t consistently get this phone to connect to my car\'s stereo unit from one day to the next.You might say just use a USB-C to 3.5mm adapter, I tried that. Sound quality was slightly better but barely. Overall I found myself having to keep my stereo lower than I\'m used to simply because the signal that this phone outputs is not good.In addition to this, I also see OxygenOS as becoming bloated and filled with things that are not relevant to the Android experience. Why is "Shot on OnePlus" on my phone? Why is Netflix preloaded and why can\'t it be uninstalled? Why is Zen mode a thing? I\'m tired of manufacturers trying to put their own spin on Android. Keep it simple, please. Just copy what Google does with the Pixel series, please.Camera quality was also another concern for me. Sometimes the OnePlus 8T takes amazing photos, other times they come out blurry, over-saturated, or there\'s so much shutter lag between hitting the capture button and the photo actually taking that you miss your shot. It\'s infuriating. Coming from a Google Pixel which captured amazing shots almost every time, feels like a bit of a downgrade. I also hate that it the 8T doesn\'t have a telephoto lens.The cost of charging accessories is another huge thing for me. Warp Charge accessories are extremely expensive, it\'s over $50 just for a Warp Charge 30 car charger. I can\'t justify spending that much money just to charge my phone even if the actual experience of using Warp Charge is awesome. The 8T doesn\'t have wireless charging which I personally don\'t care about much, but why does OnePlus use the slogan "Never Settle" when they clearly are expecting the customer to settle?In addition to this, OnePlus has been releasing so many devices lately that customers have been complaining about slow updates and poor support for older phones. Also, I\'ve just never gotten used to the ugly hole punch camera. I just don\'t see OnePlus as the brand it thinks it is. "Never Settle" is a funny slogan for a company that tries to make their customers settle for so much. Glad to be returning this mediocre phone.', 'As 2020 brought us a lot of bad things, some good things were the variety of new phones on the market in the last few months. This is my first time with a OnePlus phone and their brand has been recognized more of the years. I needed a new upgrade over the S9+ due to dead pixels at the top. I am not going to go too far into this, but when you have a SnapDragon 865 with 5G, 120 Hz Panel, In Display Fingerprint Reader, 256 Storage, 12gb Ram, a 65 Watt Charger (IN THE BOX *cough cough apple*), for 750 dollars that already tells me this value is very decent! Don\'t always fall for the reviewers on YouTube. They have been negative due to "wireless charging". Like really? It is less effective than wired charging and plus like I said, you get a 65 watt charger. It has a few flaws for sure, but nothing crazy and it feels like a flagship for sure!', 'This device cannot be activated on the Sprint network. It does not say this anywhere in the listing, I received the device today and when trying to activate it was given the following message:Potential Incompatible ReasonsUnsupported foreign Android ModelEither Android or Apple device may have been purchased Internationally instead of Domestically. Sprint does not support Internationally purchased phones.Again, do not purchase if you intend to activate with Sprint.', 'Got the phone today, copied all my info. from prior phone by bluetooth - excellent on wifi - love the phone. HOWEVER, may be listed as "unlocked" but spent 3 hrs. on chat/phone with Sprint an Oneplus only to find out not compatible with Sprint service - Sprint does not accept a phone purchased "internationally" (mind you through Amazon Services LLC, go figure).. Not sure if that is a Sprint thing, but both carriers and manufacturer should disclosed specs. that would prevent you from activating your phone in the US or wherever you\'re purchasing from and Amazon for sure should disclose the limitations/restrictions. I learned a-lot but I not enough...', 'Just got this phone from amazon warehouse deals for ~550 and I think I like it a lot.  Condition was "used very good" - and upon arrival I couldn\'t find a scratch or anything - looked like someone just took it out of the package and put it back in, but otherwise brand new.I think phone is awesome. I particularly like oneplus because it\'s one of the few manufacturers that provide ability to unlock bootloader and install lineage OS. This is about the best phone you can get if you intend to install Lineage at some point as I do. I was  debating between this and Samsung galaxy S20 FE - and unlockable bootloader just did it for me. Also clean experience - no useless bundled facebook spyware apps and such.its as fast as advertised, has all the cricket LTE bands, UFS 3.1 fast storage, fairly clean of bloatware, nice bright display, fast charging yadda yadda yadda. And as others have mentioned - despite the lack of official IP rating - many youtubers have confirmed it is in fact waterproof (YSK - however - even if phone has official IP rating - manufacturers dont cover water damage  by warranty anyways, so would not rush to go swimming with it regarless of IP rating).Things I dont like (but not gonna remove stars  - as  unfortunately all US-sold  smartphones are doing the same):- glass back. I just hate glass backs. I\'ll take metal or plastic any day of the week. Even with a case -  I do tend to drop my phones a lot and glass s the type of material that just tends to, you know - break.- no 3.5 mm jack.  shame. I much prefer simplicity of wired headphones.- no user-replaceable battery (I know that ship has sailed long ago - but im still gonna mention it)Edit: some people say they received wrong model, but I can confirm - US model KB2005.', 'Honestly, this is the best smartphone that I have owned. The build quality is absolutely amazing with a really beautiful aquamarine green gradient that really stands out. I almost chose the silver over this and I am glad that I didn\'t.  All of its functions including the fingerprint reader and 120 HZ screen operates smoothly with absolutely no problems.  Although, if you are going to apply a tempered glass screen protector I would wait to register your fingerprint until it is applied. Otherwise, you will have to erase your fingerprint and redo it after the screen protector is installed.  In addition, the 65 watt warp charging is everything that one plus says it is and more.  Your phone will absolutely charge from 0% to 100% in less than 40 minutes. I tested it and they are absolutely honest about its capability.  The biggest piece of advice that I would give somebody that is looking to purchase this phone is about finding a decent case. I actually ordered seven different cases for this phone and sent all but one back to amazon.  The 5G antenna bands on this phone are located directly at the top of the screen and a lot of manufacturers such as OtterBox do not offer cases with a lot of lip protection around the screen. In fact, they only case that OtterBox offers is there symmetry series case which is essentially a thin plastic shell that will absolutely not protect your phone if it has a serious drop.  Actually, OtterBox should have named that series The cemetery series case because, if you drop your phone that\'s exactly where it is going!  "RIP"  The problem is that the 5G antenna bands could in fact be covered and become non-functional with a case that has too much lip protection.  After purchasing several cases by manufacturers such as otterbox, Spigen and Urban armor I ultimately chose a case by poetic.  I purchased a poetic revolution series case which offers a lot of protection but I would also recommend the poetic guardian series which is a little lighter in its construction.  The poetic guardian offers a lot of protection and has a clear back so you can actually see the beautiful finish of your phone. The poetic revolution case is maximum protection with really thick and heavy armor throughout the back portion. After trying all of the different brands this is definitely the manufacturer that I would go with.  In addition, I am also using a tempered glass screen protector and tempered glass camera module protector by Luiber and the fit is absolutely perfect and will function well with your case.', 'Can\'t find a phone like this with this price and specifications compared to other brands it seems. Was worried about compatibility but works great with Verizon, just had to put my sim card in and call customer service for "cdma-less activation." It\'s only been a few days since I\'ve gotten this phone but so far I don\'t have any issues.', 'I feel bad writing this review since the device is solid. However, BE CAREFUL as WiFi calling is not enabled if you’re on the AT&T network. I know this is an AT&T issue, and it really shouldn’t fall on One Plus. If it weren’t for this connection issue, I would have kept the phone.', "Says I'm connected to Verizon but texting doesn't work. Tried fixing it through Verizon but couldn't get it to work. Oneplus Switch would freeze at around 85% every time I tried to transfer my stuff from my old phone. Pretty bummed because I loved everything I tried with the phone.", 'I got this phone as Amazon Warehouse item with a good discount from the new item price. It would be a less value if I have to pay the new unit price.The phone came with its original box, 65W charger and cable. Even the sim card pin is there. There is no screen protector on the screen but I saw no obvious sign of scratches on both front and back. May be those very very picky people will point some very micro sign of screen been wiped by cloth, for the price I paid, I would more than happy to live with it. The model number of the unit is also the US version KB2005 as described.The display screen is flat for a change. I really hate those so call 2.5D or 3D curved edge display screens that are hard to view at edge and hard to find a good screen protector. The back is still glass that while it may looks good, provide no piratical value and make it easy to break. I prefer carbon composite backs that are far more durable. The phone feels comfortable in hand but as mention, the glass back may feel at bit slip at times. A case probably is need an that really negate the purpose of glass back. Which the phone makers stop making these silly designs.As for the phone itself, it runs on One Plus version of Android 11. The only bloatware I want to remove but could not is the Netflix app.This is a dual sim phone which is the most important decision making factor. Too many US version phones has this function disabled. I was annoyed by the sim card holder however, that put one sim card on each side. This means one card is upside down when insert or pulling the card holder. This is the 1st dual sim phone I got uses this type of sim holder. It is not convenient and prone to touch the contacts and zap it with static charge. It was also a bit difficult to secure sim card in place to hold it firmly without dropping out when upside down.The volume control is on the left side of the phone instead of like many others on the right on top the power button. That position is now for the ring mute/vibrate switch. I would have proffered the volume is on the right.So far the finger print sensor works fine even with cheap screen protector but I prefer on that is on the back instead of under screen.The screen display is good with color reproduction. Since I don\'t play game, can\'t really tell the benefit from my previous phone 90 Hz to this 120Hz refresh rate.WiFi is fine with WiFi6 or AX with WPA3. It does not support the new 6E or the 6GHz band but 6E is not that great in real use anyway. WiFi6 speed download is on par with 2021 iPad Pro 12.9" peak around 900mbps when in the same room with the router and around 550mbps two rooms away. The upload speed however, this phone beats the iPad by significant margin.This phone works with T-Mobile without any problem in either 4G or 5G. In my area the T-Mobile signal is on the weak side so I would show the test speed here as it is not a fair assessment of the phone. The WiFi calling functions works most of time but some time it kind of while maintain connection but can not hear to talk to the other side of the line. This may not be the problem of the phone as other phones suffer the same problem from time to time.Cameras are ok I suppose. I use real camera to take phone so phone camera is not a as important factor as to others.The big disappointment is the battery life. This phone drain a lot of energy when just using the WiFi online. Not only one charge would not last full day with mostly WiFi and min cell usage, even when just surfing online with WiFi, a regular 5V 2A USB charger can not keep pace the the battery drain. Although the included 65W charger can do the job, a laptop power adapter these days are mostly 65W.Another annoying issue is when the phone is locked and someone called and I answered, I have yet to find a way to unlock the phone without hanging up. All my previous Android phones are able to unlock the phone when talking which may be needed to find some thing while talking.Overall, for the price I paid, I am happy with it but may not be so at higher price tag.', 'De verdad es muy buen teléfono es rápido la batería dura mucho y el cargador es muy rápido y me gusta que para abrirlo con la hueya es muy rápido y lo tiene en la pantalla frontal', '5G is only available in T mobile network. very poor fingerprint sensor. Takes a huge number of trials to setup fingerprint. Moreover it is fingerprints are not recognized easily.  White balance of pictures are average. Charging speed and battery life is good.', 'Returned the phone because the Fingure print scan does not work', 'Su rendimiento, el diseño, el color, el sistema operativo. De verdad creo que encontré una marca que ofrece algo igual o mejor que la gama alta de Iphone y Samsung. Vale la pena cada dolar que pagué.', 'I love this phone. It is my 2nd OnePlus and I do not think I could go back to Samsung. Great graphics, colors and functionality. I love the color too!', 'Like it', 'Great', 'This phone is easy to slip, the slightest missing grip on the floor, and then the back of the glass will break very large, very fragile.', 'This company and their products are amazing!', 'I just got this phone at my porch delivered this afternoon. Oh my god this is the smoothest screen I have ever seen. This thing charged so quickly! This is the phone to go for if you think the 9 series and 8 series is very expensive. This is the most worth phone for money. I love it.', 'Excelente equipo.Má ha gustado:Calidad de construcción, se siente bastante sólido, materiales de buena calidad.Velocidad de carga, es increíble que en menos de 1 hora este cargado al 100% inclusive con 20 minutos tienes batería para horas de uso.Gestión de la batería, con uso normal, facilmente llega a 8hrs de pantalla y a  el día de uso.Desempeño, el procesador SD865 no sufre para mover nada y el buen desempeño de oxygen como capa de personalización lo hacen aún mejor.He pasado por varios gamas alta y sin duda este 8T es de mis favoritos.Cómo contras tiene:Si vas a usarlo con algún OMV de Altan debes activar el voLTE por medio de la PC con un procedimiento algo engorroso al principio, cada vez que te llegue una actualización, debes hacer lo mismo.De ahí en fuera no tendrás problemas para que funcione con los operadores de México.Es difícil encontrar accesorios por ser una marca desconocida en México.Algunas app no están optimizadas para android 11, este no es un problema del terminal, pero es algo a considerar, algunas app de bancos como la de Banamex no funcionan correctamente, aunque siendo sinceros la app de Banamex rara vez funciona correctamente en algunos equipos.'])
# print(r)
# print(s)
# print(w)